<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #toolbar {
            display: flex;
            padding: 10px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            align-items: center;
            gap: 10px;
            position: relative; /* Added to ensure proper stacking context */
        }

        #formula-bar {
            flex: 1;
            margin-left: 10px;
            padding: 5px;
            font-family: monospace;
            order: 1; /* This ensures formula bar comes after the actions */
        }

        #selected-cell {
            width: 100px;
            padding: 5px;
            background-color: #eee;
            border: 1px solid #ddd;
            text-align: center;
        }

        #display-bar {
            width: 200px;
            padding: 5px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            margin-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #grid-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        #grid {
            display: grid;
            grid-template-columns: 50px repeat(var(--cols, 10), 100px);
            grid-template-rows: 30px repeat(var(--rows, 10), 25px);
        }

        .cell {
            border: 1px solid #ddd;
            padding: 4px;
            overflow: hidden;
            white-space: nowrap;
            background-color: white;
        }

        .header-cell {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            position: sticky;
            z-index: 10;
        }

        .row-header {
            left: 0;
            z-index: 20;
        }

        .col-header {
            top: 0;
        }

        .corner-header {
            top: 0;
            left: 0;
            z-index: 30;
        }

        .selected {
            background-color: #e6f3ff;
            border: 1px solid #4d90fe;
        }

        .error {
            background-color: #ffebee;
        }

        #actions {
            display: flex;
            gap: 10px;
            align-items: center;
            order: -1; /* This moves the actions div to the start of the toolbar */
        }

        .action-button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #save-button {
            background-color: #4CAF50;
            color: white;
        }

        #save-button:hover {
            background-color: #45a049;
        }

        #home-button {
            background-color: #2196F3;
            color: white;
        }

        #home-button:hover {
            background-color: #0b7dda;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: white;
            padding: 20px 30px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 6px 8px;
            margin-top: 4px;
            box-sizing: border-box;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-content button {
            margin-top: 10px;
            margin-right: 10px;
        }

        #graph-button {
            background-color: #bf63c4;
            /* a green tone */
        }

        #graph-button:hover {
            background-color: #de91d4;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Increased z-index to ensure dropdown shows on top */
            border-radius: 4px;
            top: 100%;
            right: 0;
        }

        .dropdown-content a {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
            border-radius: 4px;
        }

        #download-button {
            background-color: #5c6bc0;
            color: white;
            z-index: 1000; /* Ensure it is on top of other elements */
            position: relative; /* Ensure stacking context for z-index */
        }

        #download-button:hover {
            background-color: #3f51b5;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="toolbar">
            <div id="selected-cell"></div>
            <div id="display-bar"></div>
            <input type="text" id="formula-bar" placeholder="Enter formula here...">
            <div id="actions">
                <button id="graph-button" class="action-button">Graph</button>
                <div class="dropdown">
                    <button id="download-button" class="action-button">Download</button>
                    <div id="download-dropdown" class="dropdown-content hidden">
                        <a href="#" id="download-csv">CSV</a>
                        <a href="#" id="download-xlsx">Excel (XLSX)</a>
                    </div>
                </div>
                <button id="save-button" class="action-button">Save</button>
                <button id="home-button" class="action-button">Home</button>
            </div>
        </div>
        <div id="grid-container">
            <div id="grid"></div>
        </div>
    </div>
    <div id="graph-display-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-graph-modal" style="float:right; cursor:pointer;">&times;</span>
            <h2>Graph Preview</h2>
            <img id="graph-preview" src="" alt="Generated Graph" style="max-width: 100%; margin-top: 10px;">
        </div>
    </div>

    <div id="graph-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Create Graph</h2>
            <label>Graph Title: <input type="text" id="graph-title" placeholder="e.g., Sales Data"></label><br>
            <label>X Range: <input type="text" id="x-range" placeholder="e.g., 0-10"></label><br>
            <label>Y Range: <input type="text" id="y-range" placeholder="e.g., 0-100"></label><br>
            <label>Graph Type:
                <select id="graph-type">
                    <option value="Line">Line</option>
                    <option value="Bar">Bar</option>
                    <option value="Scatter">Scatter</option>
                    <option value="Area">Area</option>
                </select>
            </label><br>
            <label>X Label: <input type="text" id="x-label" placeholder="e.g., Time (s)"></label><br>
            <label>Y Label: <input type="text" id="y-label" placeholder="e.g., Value"></label><br>
            <button id="create-graph">Create</button>
            <button id="close-modal">Cancel</button>
        </div>
    </div>

    <div id="save-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Save Spreadsheet</h2>
            <form id="save-form">
                <label>Filename: <input type="text" id="filename-input" placeholder="e.g., my_spreadsheet"></label><br>
                <div style="margin-top: 10px;">
                    <button type="submit" id="confirm-save">Save</button>
                    <button type="button" id="cancel-save">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const grid = document.getElementById('grid');
            const formulaBar = document.getElementById('formula-bar');
            const selectedCellDisplay = document.getElementById('selected-cell');
            const displayBar = document.getElementById('display-bar');
            const saveButton = document.getElementById('save-button');
            const homeButton = document.getElementById('home-button');
            const graphButton = document.getElementById("graph-button");
            const modal = document.getElementById("graph-modal");
            const closeModal = document.getElementById("close-modal");

            graphButton.addEventListener("click", () => {
                modal.classList.remove("hidden");
            });

            closeModal.addEventListener("click", () => {
                modal.classList.add("hidden");
            });

            document.getElementById("create-graph").addEventListener("click", async function () {
                const graphtitle = document.getElementById("graph-title").value;
                const xRange = document.getElementById("x-range").value;
                const yRange = document.getElementById("y-range").value;
                const type = document.getElementById("graph-type").value;
                const xLabel = document.getElementById("x-label").value;
                const yLabel = document.getElementById("y-label").value;


                const payload = {
                    x_range: xRange,
                    y_range: yRange,
                    title: graphtitle,
                    x_label: xLabel,
                    y_label: yLabel,
                    graph_type: type,
                };

                try {
                    const response = await fetch('/api/graph', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    console.log("Content-Type:", response.headers.get("Content-Type"));

                    if (!response.ok) {
                        throw new Error("Graph generation failed");
                    }

                    const blob = await response.blob();
                    const imgUrl = URL.createObjectURL(blob);
                    document.getElementById("graph-preview").src = imgUrl;
                    document.getElementById("graph-display-modal").classList.remove("hidden");

                    const a = document.createElement("a");
                    a.href = imgUrl;
                    a.download = "graph.png";
                    a.click();


                } catch (error) {
                    alert("Error: " + error.message);
                }

                modal.classList.add("hidden");
            });
            document.getElementById("close-graph-modal").addEventListener("click", () => {
                document.getElementById("graph-display-modal").classList.add("hidden");
            });

            document.getElementById("close-modal").addEventListener("click", function () {
                const modal = document.getElementById("graph-modal");
                modal.classList.add("hidden");
            });

            let selectedCell = null;
            let sheetData = null;

            // Fetch sheet data
            async function fetchSheetData() {
                const response = await fetch('/api/sheet');
                sheetData = await response.json();
                renderGrid(sheetData.rows, sheetData.cols);
                updateCellValues(sheetData.cells);
            }

            // Render the grid
            function renderGrid(rows, cols) {
                grid.style.setProperty('--rows', rows);
                grid.style.setProperty('--cols', cols);
                grid.innerHTML = '';

                // Add corner cell (empty)
                const cornerCell = document.createElement('div');
                cornerCell.className = 'cell header-cell corner-header';
                grid.appendChild(cornerCell);

                // Add column headers (A, B, C...)
                for (let c = 1; c <= cols; c++) {
                    const colHeader = document.createElement('div');
                    colHeader.className = 'cell header-cell col-header';
                    colHeader.textContent = columnToLetter(c);
                    grid.appendChild(colHeader);
                }

                // Add rows with headers
                for (let r = 1; r <= rows; r++) {
                    // Row header (1, 2, 3...)
                    const rowHeader = document.createElement('div');
                    rowHeader.className = 'cell header-cell row-header';
                    rowHeader.textContent = r;
                    grid.appendChild(rowHeader);

                    // Regular cells
                    for (let c = 1; c <= cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.dataset.name = columnToLetter(c) + r;
                        cell.addEventListener('click', () => selectCell(cell));
                        grid.appendChild(cell);
                    }
                }
            }

            // Convert column number to letter (1=A, 2=B, etc.)
            function columnToLetter(col) {
                let letter = '';
                while (col > 0) {
                    col--;
                    letter = String.fromCharCode(65 + (col % 26)) + letter;
                    col = Math.floor(col / 26);
                }
                return letter;
            }

            // Update cell values from data
            function updateCellValues(cells) {
                cells.forEach(cellData => {
                    if (!cellData.name) return;

                    const selector = `.cell[data-name="${cellData.name}"]`;
                    const cellElement = document.querySelector(selector);
                    if (cellElement) {
                        cellElement.textContent = cellData.value;
                        if (cellData.error) {
                            cellElement.classList.add('error');
                        } else {
                            cellElement.classList.remove('error');
                        }
                        cellElement.dataset.formula = cellData.formula || '';
                    }
                });
            }

            // Select a cell
            function selectCell(cell) {
                // Deselect previously selected cell
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                }

                // Select new cell
                cell.classList.add('selected');
                selectedCell = cell;
                selectedCellDisplay.textContent = cell.dataset.name;

                // Update display bar with cell value and formula
                displayBar.textContent = `Value: ${cell.textContent || '0'}`;
                if (cell.dataset.formula) {
                    displayBar.textContent += ` | Formula: ${cell.dataset.formula}`;
                }

                // Update formula bar
                formulaBar.value = cell.dataset.formula || '';
                formulaBar.focus();
            }

            // Handle formula submission
            formulaBar.addEventListener('keydown', async function (e) {
                if (e.key === 'Enter' && selectedCell) {
                    const cellName = selectedCell.dataset.name;
                    const formula = formulaBar.value.trim();

                    try {
                        const response = await fetch('/api/update_cell', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                cell: cellName,
                                rhs: formula
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'ok') {
                            // Refresh the sheet to show all updates
                            fetchSheetData();

                            // Update the display bar
                            if (result.value !== undefined) {
                                displayBar.textContent = `Value: ${result.value}`;
                                if (formula) {
                                    displayBar.textContent += ` | Formula: ${formula}`;
                                }
                            }

                            // Clear the formula bar
                            formulaBar.value = '';
                        } else {
                            alert(`Error: ${result.status}`);
                        }
                    } catch (error) {
                        console.error('Error updating cell:', error);
                        alert('Failed to update cell');
                    }
                }
            });

            // Handle save button click
            saveButton.addEventListener('click', async function () {
                // First check if this is a loaded sheet
                const sheetInfoResponse = await fetch('/api/sheet_info');
                const sheetInfo = await sheetInfoResponse.json();
                
                // For loaded sheets, directly overwrite using the original path
                if (sheetInfo.is_loaded && sheetInfo.original_path) {
                    displayBar.textContent = "Updating existing spreadsheet file...";
                    
                    // Use the original path to save without prompting
                    const saveResponse = await fetch(`/api/save?filename=${encodeURIComponent(sheetInfo.original_path)}`, {
                        method: 'POST'
                    });
                    
                    const result = await saveResponse.json();
                    if (result.status === 'ok') {
                        displayBar.textContent = `Spreadsheet saved to ${sheetInfo.original_path}`;
                    } else {
                        throw new Error(result.message || 'Failed to save spreadsheet');
                    }
                    return;
                }
                
                // For new sheets, always ask where to save
                if ('showSaveFilePicker' in window) {
                    displayBar.textContent = "Select where to save your spreadsheet...";

                    // Set up file save options with .bin.gz extension
                    const opts = {
                        suggestedName: 'spreadsheet.bin.gz',
                        types: [{
                            description: 'Compressed Spreadsheet File',
                            accept: { 'application/gzip': ['.bin.gz'] }
                        }]
                    };

                    try {
                        // Show save file picker to get user's chosen location
                        const fileHandle = await window.showSaveFilePicker(opts);
                        const fileName = fileHandle.name;
                        
                        // Get complete path if possible (depends on browser security)
                        let filePath = fileName;
                        
                        displayBar.textContent = "Saving spreadsheet...";
                        
                        // Export the spreadsheet data
                        const exportResponse = await fetch('/api/export', {
                            method: 'POST'
                        });
                        
                        if (!exportResponse.ok) {
                            throw new Error('Failed to export spreadsheet data');
                        }
                        
                        // Get the spreadsheet data as a blob
                        const blob = await exportResponse.blob();
                        
                        // Write to the selected file using the File System Access API
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        // Now update the original_path in the server state
                        // This makes future saves go directly to this location
                        const saveResponse = await fetch(`/api/save?filename=${encodeURIComponent(filePath)}`, {
                            method: 'POST'
                        });
                        
                        const result = await saveResponse.json();
                        if (result.status !== 'ok') {
                            console.warn("Saved file successfully but failed to update original path:", result.message);
                        }

                        displayBar.textContent = `Spreadsheet saved to ${filePath}`;
                    } catch (pickErr) {
                        // User may have cancelled
                        if (pickErr.name === 'AbortError') {
                            displayBar.textContent = "Save operation cancelled.";
                            return;
                        }
                        throw pickErr;
                    }
                } else {
                    // Fallback for browsers without File System Access API
                    const filename = prompt("Enter filename to save spreadsheet:", "spreadsheet.bin.gz");
                    if (!filename) {
                        displayBar.textContent = "Save operation cancelled.";
                        return;
                    }

                    displayBar.textContent = "Preparing download...";
                    
                    // Export the spreadsheet data
                    const exportResponse = await fetch('/api/export', {
                        method: 'POST'
                    });

                    if (!exportResponse.ok) {
                        throw new Error('Failed to export spreadsheet');
                    }

                    // Get blob and trigger download
                    const blob = await exportResponse.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename.endsWith('.bin.gz') ? filename : `${filename}.bin.gz`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Try to update the original path for future saves
                    const fullFilename = filename.endsWith('.bin.gz') ? filename : `${filename}.bin.gz`;
                    const saveResponse = await fetch(`/api/save?filename=${encodeURIComponent(fullFilename)}`, {
                        method: 'POST'
                    });

                    displayBar.textContent = `Spreadsheet downloaded as ${fullFilename}`;
                }
            });

            // Add download functionality
            const downloadButton = document.getElementById('download-button');
            const downloadDropdown = document.getElementById('download-dropdown');
            const downloadCsv = document.getElementById('download-csv');
            const downloadXlsx = document.getElementById('download-xlsx');

            // Toggle dropdown when download button is clicked
            downloadButton.addEventListener('click', function () {
                downloadDropdown.classList.toggle('hidden');
            });

            // Hide dropdown when clicking elsewhere
            document.addEventListener('click', function (event) {
                if (!event.target.matches('#download-button')) {
                    if (!downloadDropdown.classList.contains('hidden')) {
                        downloadDropdown.classList.add('hidden');
                    }
                }
            });

            // Handle CSV download
            downloadCsv.addEventListener('click', async function (e) {
                e.preventDefault();
                displayBar.textContent = "Preparing CSV download...";

                try {
                    const response = await fetch('/api/download/csv');

                    if (!response.ok) {
                        throw new Error('Failed to generate CSV');
                    }

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'spreadsheet.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    displayBar.textContent = "CSV downloaded successfully";
                } catch (error) {
                    console.error('Error downloading CSV:', error);
                    displayBar.textContent = `Error: ${error.message}`;
                }

                downloadDropdown.classList.add('hidden');
            });

            // Handle XLSX download
            downloadXlsx.addEventListener('click', async function (e) {
                e.preventDefault();
                displayBar.textContent = "Preparing Excel download...";

                try {
                    const response = await fetch('/api/download/xlsx');

                    if (!response.ok) {
                        throw new Error('Failed to generate Excel file');
                    }

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'spreadsheet.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    displayBar.textContent = "Excel file downloaded successfully";
                } catch (error) {
                    console.error('Error downloading Excel:', error);
                    displayBar.textContent = `Error: ${error.message}`;
                }

                downloadDropdown.classList.add('hidden');
            });

            // Add keyboard navigation
            document.addEventListener('keydown', function (e) {
                if (!selectedCell) return;

                const currentRow = parseInt(selectedCell.dataset.row);
                const currentCol = parseInt(selectedCell.dataset.col);
                let newRow = currentRow;
                let newCol = currentCol;

                // Only navigate if not focused on formula bar
                if (document.activeElement !== formulaBar) {
                    switch (e.key) {
                        case 'ArrowUp':
                            newRow = Math.max(1, currentRow - 1);
                            break;
                        case 'ArrowDown':
                            newRow = Math.min(sheetData.rows, currentRow + 1);
                            break;
                        case 'ArrowLeft':
                            newCol = Math.max(1, currentCol - 1);
                            break;
                        case 'ArrowRight':
                            newCol = Math.min(sheetData.cols, currentCol + 1);
                            break;
                    }

                    if (newRow !== currentRow || newCol !== currentCol) {
                        const newCellSelector = `.cell[data-row="${newRow}"][data-col="${newCol}"]`;
                        const newCell = document.querySelector(newCellSelector);
                        if (newCell) {
                            selectCell(newCell);
                            e.preventDefault(); // Prevent default scrolling
                        }
                    }
                }
            });

            // Home button click handler
            homeButton.addEventListener('click', function () {
                // Extract username from the current URL path
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts.length > 0) {
                    const username = pathParts[0];
                    window.location.href = `/${username}`;
                } else {
                    // Fallback in case we can't determine the username
                    window.location.href = '/';
                }
            });

            // Initialize the grid
            fetchSheetData();

            // Add save modal functionality
            const saveModal = document.getElementById('save-modal');
            const saveForm = document.getElementById('save-form');
            const filenameInput = document.getElementById('filename-input');
            const confirmSaveBtn = document.getElementById('confirm-save');
            const cancelSaveBtn = document.getElementById('cancel-save');
            
            // Modified save button click handler
            saveButton.addEventListener('click', async function() {
                // First check if this is a loaded sheet
                const sheetInfoResponse = await fetch('/api/sheet_info');
                const sheetInfo = await sheetInfoResponse.json();
                
                // For loaded sheets with an original path, save directly
                if (sheetInfo.is_loaded && sheetInfo.original_path) {
                    displayBar.textContent = "Updating existing spreadsheet...";
                    
                    // Use the original path to save without prompting
                    const saveResponse = await fetch(`/api/save?filename=${encodeURIComponent(sheetInfo.original_path)}`, {
                        method: 'POST'
                    });
                    
                    const result = await saveResponse.json();
                    if (result.status === 'ok') {
                        displayBar.textContent = `Spreadsheet saved successfully!`;
                    } else {
                        displayBar.textContent = `Error: ${result.message || 'Failed to save spreadsheet'}`;
                    }
                    return;
                }
                
                // For new sheets, show the save dialog
                saveModal.classList.remove('hidden');
                filenameInput.focus();
            });
            
            // Handle save form submission
            saveForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const filename = filenameInput.value.trim();
                if (!filename) {
                    alert('Please enter a filename');
                    return;
                }
                
                displayBar.textContent = "Saving spreadsheet...";
                saveModal.classList.add('hidden');
                
                try {
                    // Save with the specified name to the user's directory
                    const formData = new FormData();
                    formData.append('name', filename);
                    
                    const saveResponse = await fetch('/api/save_with_name', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await saveResponse.json();
                    if (result.status === 'ok') {
                        displayBar.textContent = `Spreadsheet saved as ${filename}`;
                    } else {
                        throw new Error(result.message || 'Failed to save spreadsheet');
                    }
                } catch (error) {
                    console.error('Error saving spreadsheet:', error);
                    displayBar.textContent = `Error: ${error.message}`;
                }
            });
            
            // Cancel save operation
            cancelSaveBtn.addEventListener('click', function() {
                saveModal.classList.add('hidden');
            });
        });
    </script>
</body>

</html>