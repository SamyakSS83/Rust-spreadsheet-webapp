<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #toolbar {
            display: flex;
            padding: 10px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            align-items: center;
        }
        
        #formula-bar {
            flex: 1;
            margin-left: 10px;
            padding: 5px;
            font-family: monospace;
        }
        
        #selected-cell {
            width: 100px;
            padding: 5px;
            background-color: #eee;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        #display-bar {
            width: 200px;
            padding: 5px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            margin-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #grid-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        #grid {
            display: grid;
            grid-template-columns: 50px repeat(var(--cols, 10), 100px);
            grid-template-rows: 30px repeat(var(--rows, 10), 25px);
        }
        
        .cell {
            border: 1px solid #ddd;
            padding: 4px;
            overflow: hidden;
            white-space: nowrap;
            background-color: white;
        }
        
        .header-cell {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
            position: sticky;
            z-index: 10;
        }
        
        .row-header {
            left: 0;
            z-index: 20;
        }
        
        .col-header {
            top: 0;
        }
        
        .corner-header {
            top: 0;
            left: 0;
            z-index: 30;
        }
        
        .selected {
            background-color: #e6f3ff;
            border: 1px solid #4d90fe;
        }
        
        .error {
            background-color: #ffebee;
        }
        
        #actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        #save-button:hover {
            background-color: #45a049;
        }
        
        #home-button {
            background-color: #2196F3;
            color: white;
        }
        
        #home-button:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="toolbar">
            <div id="selected-cell"></div>
            <div id="display-bar"></div>
            <input type="text" id="formula-bar" placeholder="Enter formula here...">
            <div id="actions">
                <button id="save-button" class="action-button">Save</button>
                <button id="home-button" class="action-button">Home</button>
            </div>
        </div>
        <div id="grid-container">
            <div id="grid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('grid');
            const formulaBar = document.getElementById('formula-bar');
            const selectedCellDisplay = document.getElementById('selected-cell');
            const displayBar = document.getElementById('display-bar');
            const saveButton = document.getElementById('save-button');
            const homeButton = document.getElementById('home-button');
            
            let selectedCell = null;
            let sheetData = null;
            
            // Fetch sheet data
            async function fetchSheetData() {
                const response = await fetch('/api/sheet');
                sheetData = await response.json();
                renderGrid(sheetData.rows, sheetData.cols);
                updateCellValues(sheetData.cells);
            }
            
            // Render the grid
            function renderGrid(rows, cols) {
                grid.style.setProperty('--rows', rows);
                grid.style.setProperty('--cols', cols);
                grid.innerHTML = '';
                
                // Add corner cell (empty)
                const cornerCell = document.createElement('div');
                cornerCell.className = 'cell header-cell corner-header';
                grid.appendChild(cornerCell);
                
                // Add column headers (A, B, C...)
                for (let c = 1; c <= cols; c++) {
                    const colHeader = document.createElement('div');
                    colHeader.className = 'cell header-cell col-header';
                    colHeader.textContent = columnToLetter(c);
                    grid.appendChild(colHeader);
                }
                
                // Add rows with headers
                for (let r = 1; r <= rows; r++) {
                    // Row header (1, 2, 3...)
                    const rowHeader = document.createElement('div');
                    rowHeader.className = 'cell header-cell row-header';
                    rowHeader.textContent = r;
                    grid.appendChild(rowHeader);
                    
                    // Regular cells
                    for (let c = 1; c <= cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.dataset.name = columnToLetter(c) + r;
                        cell.addEventListener('click', () => selectCell(cell));
                        grid.appendChild(cell);
                    }
                }
            }
            
            // Convert column number to letter (1=A, 2=B, etc.)
            function columnToLetter(col) {
                let letter = '';
                while (col > 0) {
                    col--;
                    letter = String.fromCharCode(65 + (col % 26)) + letter;
                    col = Math.floor(col / 26);
                }
                return letter;
            }
            
            // Update cell values from data
            function updateCellValues(cells) {
                cells.forEach(cellData => {
                    if (!cellData.name) return;
                    
                    const selector = `.cell[data-name="${cellData.name}"]`;
                    const cellElement = document.querySelector(selector);
                    if (cellElement) {
                        cellElement.textContent = cellData.value;
                        if (cellData.error) {
                            cellElement.classList.add('error');
                        } else {
                            cellElement.classList.remove('error');
                        }
                        cellElement.dataset.formula = cellData.formula || '';
                    }
                });
            }
            
            // Select a cell
            function selectCell(cell) {
                // Deselect previously selected cell
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                }
                
                // Select new cell
                cell.classList.add('selected');
                selectedCell = cell;
                selectedCellDisplay.textContent = cell.dataset.name;
                
                // Update display bar with cell value and formula
                displayBar.textContent = `Value: ${cell.textContent || '0'}`;
                if (cell.dataset.formula) {
                    displayBar.textContent += ` | Formula: ${cell.dataset.formula}`;
                }
                
                // Update formula bar
                formulaBar.value = cell.dataset.formula || '';
                formulaBar.focus();
            }
            
            // Handle formula submission
            formulaBar.addEventListener('keydown', async function(e) {
                if (e.key === 'Enter' && selectedCell) {
                    const cellName = selectedCell.dataset.name;
                    const formula = formulaBar.value.trim();
                    
                    try {
                        const response = await fetch('/api/update_cell', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                cell: cellName,
                                formula: formula
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'ok') {
                            // Refresh the sheet to show all updates
                            fetchSheetData();
                            
                            // Update the display bar
                            if (result.value !== undefined) {
                                displayBar.textContent = `Value: ${result.value}`;
                                if (formula) {
                                    displayBar.textContent += ` | Formula: ${formula}`;
                                }
                            }
                            
                            // Clear the formula bar
                            formulaBar.value = '';
                        } else {
                            alert(`Error: ${result.status}`);
                        }
                    } catch (error) {
                        console.error('Error updating cell:', error);
                        alert('Failed to update cell');
                    }
                }
            });
            
            // Handle save button click
            saveButton.addEventListener('click', async function() {
                try {
                    // Check if File System Access API is supported
                    if ('showSaveFilePicker' in window) {
                        displayBar.textContent = "Preparing to save...";
                        
                        // Set up file save options
                        const opts = {
                            suggestedName: 'spreadsheet.bin.gz',
                            types: [{
                                description: 'Compressed Spreadsheet File',
                                accept: {'application/gzip': ['.bin.gz']}
                            }]
                        };
                        
                        try {
                            // Show save file picker
                            const fileHandle = await window.showSaveFilePicker(opts);
                            
                            // Request file export from server
                            const response = await fetch('/api/export', {
                                method: 'POST'
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to export spreadsheet');
                            }
                            
                            // Get the file blob
                            const blob = await response.blob();
                            
                            // Write to the selected file
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            
                            displayBar.textContent = "Spreadsheet saved successfully!";
                        } catch (pickErr) {
                            // User may have cancelled
                            if (pickErr.name === 'AbortError') {
                                displayBar.textContent = "Save operation cancelled.";
                                return;
                            }
                            throw pickErr;
                        }
                    } else {
                        // Fallback for browsers without File System Access API
                        const filename = prompt("Enter filename to save (will be saved with .bin.gz extension):", "spreadsheet");
                        if (!filename) return;
                        
                        displayBar.textContent = "Preparing download...";
                        
                        const response = await fetch('/api/export', {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to export spreadsheet');
                        }
                        
                        // Get blob and trigger download
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${filename}.bin.gz`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        displayBar.textContent = `Spreadsheet downloaded as ${filename}.bin.gz`;
                    }
                } catch (error) {
                    console.error('Error saving spreadsheet:', error);
                    displayBar.textContent = `Error: ${error.message}`;
                }
            });
            
            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (!selectedCell) return;
                
                const currentRow = parseInt(selectedCell.dataset.row);
                const currentCol = parseInt(selectedCell.dataset.col);
                let newRow = currentRow;
                let newCol = currentCol;
                
                // Only navigate if not focused on formula bar
                if (document.activeElement !== formulaBar) {
                    switch (e.key) {
                        case 'ArrowUp':
                            newRow = Math.max(1, currentRow - 1);
                            break;
                        case 'ArrowDown':
                            newRow = Math.min(sheetData.rows, currentRow + 1);
                            break;
                        case 'ArrowLeft':
                            newCol = Math.max(1, currentCol - 1);
                            break;
                        case 'ArrowRight':
                            newCol = Math.min(sheetData.cols, currentCol + 1);
                            break;
                    }
                    
                    if (newRow !== currentRow || newCol !== currentCol) {
                        const newCellSelector = `.cell[data-row="${newRow}"][data-col="${newCol}"]`;
                        const newCell = document.querySelector(newCellSelector);
                        if (newCell) {
                            selectCell(newCell);
                            e.preventDefault(); // Prevent default scrolling
                        }
                    }
                }
            });
            
            // Home button click handler
            homeButton.addEventListener('click', function() {
                window.location.href = '/';
            });
            
            // Initialize the grid
            fetchSheetData();
        });
    </script>
</body>
</html>